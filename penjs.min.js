!function(e){function t(e){function t(t,i,o){if(!(o<=i)){var a={type:t,pos:i,endpos:o};return"text"!==t&&"comment"!==t||(a.value=e.slice(i,o)),r=o,n.push(a),a}}for(var n=[],r=0;r<e.length;){var i=e.slice(r).match(/([^\S\n]*)(?:<(!--)|<\/(:?[\w_]+[\w_-]*[\w_]|[\w_]+)\s*>|<(:?[\w_]+[\w_-]*[\w_]|[\w_]+)\s*)/);if(!i)break;t("text",r,r+i.index);var o=i[0].length,a=i[1];if(i[2]){if(!(i=e.slice(r+o).match(/-->/))){t("comment",r,e.length).indent=a;break}o+=i.index+i[0].length;t("comment",r,r+o).indent=a}else{var c=i[3];if(c){var u=t("right",r,r+o);u.tag=c,u.indent=a}else{c=i[4];for(var s=[];;){if(!(i=e.slice(r+o).match(/^\s*([:@]?[\w_]+[\w_\-.]*[\w_]|[\w_]+)\s*/)))break;o+=i[0].length;var l=i[1],f="",d="";switch(i=e.slice(r+o).match(/^\s*=\s*((')([^']*)'|(")([^"]*)"|([^'"\s\/>]+))\s*/),i&&(o+=i[0].length,f=i[1],d=i[2]||i[4]||""),d){case'"':case"'":f=f.slice(1,-1)}s.push({name:l,value:f,quoted:d})}if(!(i=e.slice(r+o).match(/^\s*(\/?)>/)))break;o+=i[0].length;var p=i[1]||v.indexOf(c)>=0,h=t(p?"single":"left",r,r+o);h.tag=c,h.attrs=s,h.indent=a,h.selfClosing=v.indexOf(c)>=0}}}return t("text",r,e.length),n}function n(e){var n={type:"root",pos:0,endpos:e.length,children:[]},i=n,o=t(e),a=[];return o.forEach(function(t){switch(t.type){case"comment":case"single":case"text":i.children.push(t),i.endpos=t.endpos;break;case"left":t.children=[],a.push(t),i.children.push(t),i=t;break;case"right":var o=void 0,c=void 0;if(a.length<=0)throw o=e.slice(0,t.endpos).split("\n"),o.length,o[o.length-1].length+1,r(o,5),c="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(c),c;for(var u=a.length-1;u>=0;u--){var s=a[u],l=a[u-1];if(s.tag===t.tag){s.type="block",s.endpos=t.endpos,i=l||n,i.endpos=s.endpos,a=a.slice(0,u);break}if(!l)throw o=e.slice(0,t.endpos).split("\n"),o.length,o[o.length-1].length+1,r(o,5),c="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(c),c;s.type="text",delete s.children,delete s.tag,delete s.attrs}}}),n}function r(e,t){for(var n=e.length.toString().length,r=e.slice(-t),i=r.length-1;i>=0;i--){var o=(e.length+i-r.length+1).toString();o=new Array(n-o.length+1).join(" ")+o,r[i]=o+(i===r.length-1?" > ":"   ")+"| "+r[i]}console.log(r.join("\n"))}function i(e,t,n){if(!e)return"";var r=e.indent||"";if(n&&n(e,t),e.overwriteNode)return e.overwriteNode;var o="";return e.beforebegin&&(o+=e.beforebegin),"text"===e.type||"comment"===e.type?o+=e.value:e.tag&&(o&&"\n"!==o[o.length-1]||(o+=r),o+="<"+e.tag,"string"==typeof e.overwriteAttrs?e.overwriteAttrs&&(o+=" "+e.overwriteAttrs):e.attrs.forEach(function(e){o+=" "+e.name,e.value&&(o+="="+e.quoted+e.value+e.quoted)}),"single"===e.type?(e.selfClosing||(o+="/"),o+=">"):o+=">"),e.selfClosing||"single"===e.type||(e.beforeend&&(o+=e.beforeend),e.children&&e.children.forEach(function(r){r.parent=e,o+=i(r,t,n)}),e.afterbegin&&(o+=e.afterbegin),e.tag&&("\n"===o[o.length-1]&&(o+=r),o+="</"+e.tag+">")),e.afterend&&(o+=e.afterend),o}function o(e,t,n){function r(r,i){if(!n||n(r)){var o=Object.getOwnPropertyDescriptor(e,r);if(!o||!1!==o.configurable){var a=o&&o.get,c=o&&o.set;Object.defineProperty(e,r,{enumerable:!0,configurable:!0,get:function(){return a?a.call(e):i},set:function(n){n!==(a?a.call(e):i)&&(c?c.call(e,n):i=n,t(e))}})}}}t&&(Array.isArray(e)?["push","pop","shift","unshift","splice","sort","reverse"].forEach(function(n){var r=e[n];Object.defineProperty(e,n,{value:function(){var n=r.apply(this,arguments);return t(e),n},enumerable:!1,writable:!0,configurable:!0})}):Object.keys(e).forEach(function(t){r(t,e[t])}))}function a(e,t){var n=e.indent||"";if("root"===e.type)return e.beforebegin=n+"/***/ var _rootScope_ = "+t+".bind(this, { root: true }, null, function (_output_, _scope_) {",void(e.afterend="\n"+n+"/***/ }); _rootScope_.innerRender(_output_); "+t+".$$scope = _rootScope_;");if(e.tag&&e.attrs&&e.attrs.length){if(":template"===e.tag)return void e.attrs.some(function(r){if("name"===r.name)return e.overwriteNode="\n"+n+"/***/ _output_.push("+t+".templateRender("+JSON.stringify(r.value)+", _scope_, "+t+".bind));",!0});var r,i,o="\n"+n+"/***/ var _attrs_ = [\n";e.attrs.forEach(function(e){var a;if(":"===e.name[0])":bind"===e.name&&(i=e.value),r=!0,a=e.value;else if("@"===e.name[0]){var c=e.name.split("."),u=c[1];a=u?"function (event) { if ("+t+".eventChecker(event, "+JSON.stringify(u)+")) { with ("+t+"._imports || {}) { "+e.value+" }}}":"function (event) { with ("+t+"._imports || {}) { "+e.value+" }}",r=!0}else a=JSON.stringify(e.value);o+=n+"/***/ { name: "+JSON.stringify(e.name)+", value: "+a+", quoted: "+JSON.stringify(e.quoted)+"},\n"}),r&&(e.beforebegin="",i&&(e.beforebegin+="\n"+n+"/***/ "+t+".bind("+i+", _scope_, function (_output_, _scope_, holdInner) {\n",e.beforeend="\n"+n+"/***/ _scope_.innerRender = function(_output_) {\n",e.afterbegin="\n"+n+"/***/ }; if (holdInner) { _scope_.innerRender(_output_); }\n",e.afterend="\n"+n+"/***/ }).outerRender(_output_, true);\n"),o+=n+"/***/ ];\n",e.beforebegin+=o,e.overwriteAttrs="!#{"+t+"._attrsRender(_scope_, _attrs_)}")}}function c(e){return!!/^.*#\{[^}]*\}.*$/.test(e)||(!!/^[ \t]*[&=:|].*$/.test(e)||(!!/^[ \w\t_$]*([^&\^?|\n\w\/'"{}\[\]+\-():;,!` \t=\.$_]|:\/\/).*$/.test(e)||(!!/^\s*[`\-+'"]{3,}/.test(e)||!!/^(?!\s*(else|do|try|finally|void|typeof\s[\w$_]*)\s*$)[^'"`!:;{}()\[\],\n|=&\/^?]+$/.test(e))))}function u(e){if(!e)return function(){return""};var t=String(e).split(/\n\r?/).map(function(e,t,n){if(/^\s*$/.test(e))return e;if(c(e)){var r=[],i=0;e.replace(/(!?#)\{((?:"(?:[^\\"]|(?:\\.))*"|'(?:[^\\']|(?:\\.))*'|(?:[^{}]*\{[^}]*\})?|[^}]*)*)\}/g,function(t,n,o,a){var c=e.slice(i,a);if(c&&r.push(JSON.stringify(c)),i=a+t.length,o)switch(/^[a-z$][\w$]+$/i.test(o)&&!/^(true|false|NaN|null|this)$/.test(o)&&(o="typeof "+o+"==='undefined'?'':"+o),n){case"#":r.push("_encode_("+o+")");break;case"!#":r.push("("+o+")")}});var o=e.slice(i,e.length);return o&&r.push(JSON.stringify(o)),t<n.length-1&&r.push('"\\n"'),"_output_.push("+r+");"}return e});return t.unshift("with(this){"),t.push("}"),new Function("_output_","_encode_","helper","jhtmls","require",t.join("\n"))}function s(e){return String(e).replace(/["<>& ']/g,function(e){return"&"+_[e]+";"})}function l(e,t,n){"function"==typeof e&&(e=String(e).replace(/[^]*\/\*!?\s*|\s*\*\/[^]*/g,""));var r=u(e),i=function(e,t){var n;"function"==typeof require&&(n=require);var i=[];return void 0===t&&(t=function(e){r.call(e,i,s,t,w,n)}),r.call(e,i,s,t,w,n),i.join("")};return arguments.length<=1?i:i(t,n)}function f(e,t,n){function r(n){var s=[].slice.call(e.querySelectorAll(t));for(a=n.target;a&&s.indexOf(a)<0;)a=a.parentNode;if(a)if(c=Date.now(),/touchstart/i.test(n.type)){u||(u=!0,e.removeEventListener("mousedown",r),document.removeEventListener("mouseup",i));var l=(n.touches||{})[0]||{};o=[l.clientX||0,l.clientY||0]}else o=[n.clientX,n.clientY]}function i(e){if(o){var t;if(/touchend/i.test(e.type)){var r=(e.touches||{})[0]||(e.changedTouches||{})[0]||{};t=[r.clientX||0,r.clientY||0]}else t=[e.clientX,e.clientY];Math.sqrt(Math.pow(o[0]-t[0],2)+Math.pow(o[1]-t[1],2))<50&&n(a,Date.now()-c),o=null,a=null}}"string"==typeof e&&(e=document.querySelector(e));var o,a,c,u;e.addEventListener("touchstart",r,!1),document.addEventListener("touchend",i,!1),e.addEventListener("mousedown",r,!1),document.addEventListener("mouseup",i,!1),window.addEventListener("scroll",function(){o=null,a=null})}function d(e,t,n,r){r=r||function(){};var i=new XMLHttpRequest;i.open(t,e,!0),i.onreadystatechange=function(){if(4==i.readyState){var e=i.responseText;try{e=JSON.parse(e),r(null,e,i)}catch(t){r(t.message,e,i)}}},i.send(n?n(i):null)}function p(e,t,n){d(e,"POST",function(e){return e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),Object.keys(t).map(function(e){return e+"="+encodeURIComponent(t[e])}).join("&")},n)}function h(e,t){d(e,"GET",null,t)}var v=["area","base","br","col","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"],g={parse:n,build:i},m=0,b=function(){function e(e){var t=this;e=e||{},this._binds={},this._templates={},this._bindObjectName=e.bindObjectName||"jnodes.binder",this._bindAttributeName=e.bindAttributeName||"bind",this._scopeAttributeName=e.scopeAttributeName||"data-jnodes-scope",this._eventAttributePrefix=e.eventAttributePrefix||"data-jnodes-event-",this._imports=e.imports,this._templates={},this._compiler={},this._checkers={},this._findElement=e.findElement||function(e){return document.querySelector("["+t._scopeAttributeName+'="'+e.id+'"]')},this._updateElement=e.updateElement||function(e,n){if(e&&(n.outerRender||n.innerRender)){t.lifecycleEvent(n,"destroy"),t.cleanChildren(n);var r=[];if(n.innerRender)if(n.outerRender){n.outerRender(r,!1);var i=r.join("");r=[],n.shell===i?(n.innerRender(r),e.innerHTML=r.join("")):(n.shell=i,n.outerRender(r,!0),e.outerHTML=r.join(""))}else n.innerRender(r),e.innerHTML=r.join("");else n.outerRender(r,!0),e.outerHTML=r.join("");t.lifecycleEvent(n,"create"),t.lifecycleEvent(n,"update")}},this._attrsRender=e.attrsRender||function(e,n){if(!n)return"";var r={},i={};return n.filter(function(n){if(":"!==n.name[0]&&"@"!==n.name[0])return!0;var o=n.name.slice(1);if(o===t._bindAttributeName)o=t._scopeAttributeName;else if("@"===n.name[0]){var a=o.split(".");o=a[0],"create"===o?e.lifecycleCreate=!0:"destroy"===o?e.lifecycleDestroy=!0:"update"===o&&(e.lifecycleUpdate=!0),o=t._eventAttributePrefix+o}var c=r[o]=r[o]||[];if(i[o]=n.quoted,o===t._scopeAttributeName)return void c.push(e.id);if(""!==n.value&&null!==n.value&&void 0!==n.value&&!1!==n.value)switch(typeof n.value){case"boolean":case"number":case"string":c.push(n.value);break;case"object":Object.keys(n.value).forEach(function(e){n.value[e]&&c.push(e)});break;case"function":var u="@"+(m++).toString(36);e.methods=e.methods||{},e.methods[u]=n.value,c.push(u)}}).forEach(function(e){var t=r[e.name]=r[e.name]||[];""===e.value||t.indexOf(e.value)>=0||t.push(e.value)}),Object.keys(r).map(function(e){var t=r[e];if(t.length<=0)return null;var n=i[e]||"";return 1===t.length&&!0===t[0]?""+e:e+"="+n+t.join(" ")+n}).join(" ")}}return e.prototype.registerTemplate=function(e,t){this._templates[e]=t},e.prototype.templateRender=function(e,t){var n=this._templates[e];if(n)return n(t)},e.prototype.registerChecker=function(e,t){this._checkers[e]=t},e.prototype.eventChecker=function(e,t){var n=this._checkers[e.type];if(n)return n(e,t)},e.prototype.templateCompiler=function(e,t){var n=this._compiler[e];if(n)return n(t,this._bindObjectName)},e.prototype.registerCompiler=function(e,t){this._compiler[e]=t},e.prototype.cleanChildren=function(e){var t=this;e.children&&e.children.forEach(function(n){var r=n.model&&n.model.$$binds;if(r){var i=r.indexOf(n);i>=0&&r.splice(i,1)}delete t._binds[n.id],t.cleanChildren(n),e.children=[],delete e.methods,delete e.attrs})},e.prototype.lifecycleEvent=function(e,t){function n(e){return"update"!==t?!!("create"===t&&e.lifecycleCreate||"destroy"===t&&e.lifecycleDestroy)||(e.children?e.children.some(n):void 0):!!e.lifecycleUpdate||void 0}var r=this;if(n(e)){var i=this.element(e);if("update"===t)this.triggerScopeEvent({type:t,target:i});else{[].slice.apply(i.querySelectorAll("["+this._eventAttributePrefix+t+"]")).forEach(function(e){r.triggerScopeEvent({type:t,target:e}),e.removeAttribute(""+r._eventAttributePrefix+t)})}}},e.prototype.bind=function(e,t,n,r){var i=this,a={model:e,parent:t,binder:this};return Object.defineProperty(a,"element",{enumerable:!0,configurable:!0,get:function(){return a._element},set:function(e){a._element=e,e&&(e.setAttribute(i._scopeAttributeName,a.id),i.lifecycleEvent(a,"create"))}}),n&&(a.outerRender=function(e,t){return n(e,a,t)}),r&&(a.innerRender=function(e){return r(e,a)}),a.id=(m++).toString(36),this._binds[a.id]=a,t&&(t.children=t.children||[],t.children.push(a)),e&&"object"==typeof e&&(e.$$binds?e.$$binds.push(a):(e.$$binds=[a],o(e,function(){e.$$binds.forEach(function(e){e.binder.update(e)})},function(e){return e&&"$$"!==e.slice(2)}))),a},e.prototype.element=function(e){return e._element||this._findElement(e)},e.prototype.update=function(e){this._updateElement(this.element(e),e)},e.prototype.scope=function(e){var t;if("string"==typeof e){if(t=this._binds[e])return t}else for(var n=e;n&&n.getAttribute;){var r=this.scope(n.getAttribute(this._scopeAttributeName));if(r)return r;n=n.parentNode}},e.prototype.triggerScopeEvent=function(e,t){if(t=t||e.target){var n=t.getAttribute(this._eventAttributePrefix+e.type);if(n&&"@"===n[0]){var r=this.scope(t);if(!r)return;n.replace(/@\w+/g,function(n){var i=(r.methods||{})[n];return i&&i.call(t,e),""})}}},e}(),_={'"':"#34","'":"#39","<":"lt",">":"gt","&":"amp"," ":"nbsp"},y=0,w=function(e,t){function n(e,t,n){for(var r=[].slice.call(e.querySelectorAll(n));t&&r.indexOf(t)<0;)t=t.parentNode;return t}function r(e,t){return({esc:[27],tab:[9],enter:[13],space:[32],up:[38],left:[37],right:[39],down:[40],delete:[8,46]}[t]||[]).indexOf(e.keyCode)>=0}if(t=t||{},t.data=t.data||{},"string"==typeof e&&(e=document.querySelector(e)),e){var i,o;if(/script/i.test(e.tagName)?(o=e,i=e.parentNode):(o=e.querySelector("script"),i=e),o&&i){var c=o.getAttribute("type").match(/text\/([\w]+)/);if(c){var u="binder"+(y++).toString(36),s=penjs[u]=new b({bindObjectName:"penjs."+u,imports:function(e,t){if(e){var n={};return Object.keys(e).forEach(function(r){var i=e[r];n[r]="function"==typeof i?function(){i.apply(t,arguments)}:i}),n}}(t.methods,t.data)});"function"==typeof t.init&&t.init.call(t.data,s),["click","dblclick","keydown","keyup","focusin","focusout","change"].forEach(function(e){i.addEventListener(e,function(t){t.target.getAttribute(s._eventAttributePrefix+"input")&&("focusin"===e?t.target.addEventListener("input",function(e){s.triggerScopeEvent(e)}):"focusout"===e&&t.target.removeEventListener("input",function(e){s.triggerScopeEvent(e)}));var r=n(i,t.target,"["+s._eventAttributePrefix+e+"]");r&&s.triggerScopeEvent(t,r)})}),f(i,"["+s._eventAttributePrefix+"tap]",function(e,t){s.triggerScopeEvent({type:"tap",target:e})}),s.registerChecker("keyup",r),s.registerChecker("keydown",r),s.registerCompiler("jhtmls",function(e,t){return l(g.build(g.parse(e),t,a))});var d=c[1],p=s.templateCompiler(d,o.innerHTML);return p&&(i.innerHTML=p(t.data||{})),s.$$scope.element=i,t.data}}}};w.Parser=g,w.Ajax={post:p,get:h},"function"==typeof define?(define.amd||define.cmd)&&define(function(){return w}):"undefined"!=typeof module&&module.exports?module.exports=w:window.penjs=w}();